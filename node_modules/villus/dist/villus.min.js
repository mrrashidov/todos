/**
  * villus v1.2.2
  * (c) 2022 Abdelrahman Awad
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue"),require("graphql")):"function"==typeof define&&define.amd?define(["exports","vue","graphql"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Villus={},e.Vue,e.graphql)}(this,(function(e,t,r){"use strict";function n(e){return t.isRef(e)?t.unref(e):"function"==typeof e?e():e}function o(e){return"string"==typeof e?new r.GraphQLError(e):"object"==typeof e&&e.message?new r.GraphQLError(e.message,e.nodes,e.source,e.positions,e.path,e,e.extensions||{}):e}class u extends Error{constructor({response:e,networkError:t,graphqlErrors:r}){const n=null==r?void 0:r.map(o),u=((e,t)=>{let r="";return void 0!==e?r=`[Network] ${e.message}`:(void 0!==t&&t.forEach((e=>{r+=`[GraphQL] ${e.message}\n`})),r.trim())})(t,n);super(u),this.name="CombinedError",this.response=e,this.message=u,this.networkError=t,this.graphqlErrors=n}get isGraphQLError(){return!(!this.graphqlErrors||!this.graphqlErrors.length)}toString(){return this.message}}var a=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var r,n="boolean"==typeof t.cycles&&t.cycles,o=t.cmp&&(r=t.cmp,function(e){return function(t,n){var o={key:t,value:e[t]},u={key:n,value:e[n]};return r(o,u)}}),u=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);var r,a;if(Array.isArray(t)){for(a="[",r=0;r<t.length;r++)r&&(a+=","),a+=e(t[r])||"null";return a+"]"}if(null===t)return"null";if(-1!==u.indexOf(t)){if(n)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var i=u.push(t)-1,s=Object.keys(t).sort(o&&o(t));for(a="",r=0;r<s.length;r++){var c=s[r],l=e(t[c]);l&&(a&&(a+=","),a+=JSON.stringify(c)+":"+l)}return u.splice(i,1),"{"+a+"}"}}(e)};function i(e){return"string"==typeof e?e:e&&e.kind?r.print(e):null}async function s(e){let t;const r={ok:e.ok,statusText:e.statusText,status:e.status,headers:e.headers};try{t=await e.json()}catch(e){return Object.assign(Object.assign({},r),{statusText:e.message,body:null})}return Object.assign(Object.assign({},r),{body:t})}const c={method:"POST",headers:{"content-type":"application/json"}};function l({query:e,variables:t},r){const n=i(e);if(!n)throw new Error("A query must be provided.");return o={body:JSON.stringify({query:n,variables:t})},u=r,Object.assign(Object.assign(Object.assign({},o),u),{method:u.method||o.method||c.method,headers:Object.assign(Object.assign({},o.headers||{}),u.headers||{})});var o,u}function f(e){let t,r,n;for(t=5381,r=0,n=0|e.length;r<n;r++)t=(t<<5)+t+e.charCodeAt(r);return t>>>0}function d(e,...t){const r=e.variables?a(e.variables):"";return f(`${i(e.query)}${r}${t.join("")}`)}function p(e,t){return e.slots.default&&e.slots.default(t)||[]}function y(){const e={};return function({afterQuery:t,useResult:r,operation:n}){if("query"!==n.type||"network-only"===n.cachePolicy)return;t((t=>{!function({key:t},r){e[t]=r}(n,t)}));const o=function({key:t}){return e[t]}(n);return"cache-only"===n.cachePolicy?r(o||{data:null,error:null},!0):o?r(o,"cache-first"===n.cachePolicy):void 0}}function h(e){const t=(null==e?void 0:e.fetch)||("undefined"!=typeof window&&"fetch"in window&&window.fetch?window.fetch.bind(window):"undefined"!=typeof global&&"fetch"in global?global.fetch:"undefined"!=typeof self&&"fetch"in self?self.fetch:void 0);if(!t)throw new Error("Could not resolve a fetch() method, you should provide one.");return async function(e){var r,n;const{useResult:o,opContext:a,operation:i}=e,c=l(i,a);let f;try{f=await t(a.url,c).then(s)}catch(e){return o({data:null,error:new u({response:f,networkError:e})},!0)}e.response=f;const d=null===(r=f.body)||void 0===r?void 0:r.data;if(!f.ok||!f.body){const e={response:f};return(null===(n=f.body)||void 0===n?void 0:n.errors)?e.graphqlErrors=f.body.errors:e.networkError=new Error(f.statusText),o({data:d,error:new u(e)},!0)}o({data:d,error:f.body.errors?new u({response:f,graphqlErrors:f.body.errors}):null},!0)}}function v(){const e={};return function(t){if("query"!==t.operation.type)return;const{useResult:r}=t;t.afterQuery((()=>{delete e[t.operation.key]}));const n=e[t.operation.key];if(n)return n.then((e=>{r(e,!0)}));let o;e[t.operation.key]=new Promise((e=>{o=e})),t.useResult=function(...e){r(...e),o(e[0])}}}const b=Symbol("villus.client");let g;const w=e=>g=e,m=()=>{var e;const r=t.getCurrentInstance();return r?(null===(e=r.provides)||void 0===e?void 0:e[b])||t.inject(b,g):g},O=()=>[y(),v(),h()];class q{constructor(e){this.install=()=>{},this.url=e.url,this.defaultCachePolicy=e.cachePolicy||"cache-first",this.plugins=e.use||[...O()]}async execute(e,t,r,n){let o;const u=Object.assign(Object.assign({url:this.url},c),{headers:Object.assign(Object.assign({},c.headers),(null==r?void 0:r.headers)||{})});let a=!1;const i=[],s={useResult(e,t){t&&(a=!0),o&&(null==n||n(e)),o=e},afterQuery(e){i.push(e)},operation:Object.assign(Object.assign({},e),{key:d(e),type:t,cachePolicy:("cachePolicy"in e?e.cachePolicy:this.defaultCachePolicy)||this.defaultCachePolicy}),opContext:u};let l=0;for(let e=0;e<this.plugins.length;e++){const t=this.plugins[e];if(await t(s),o){l=e;break}}return new Promise(((e,t)=>{o?(e(o),(async()=>{if(!a)for(let e=l+1;e<this.plugins.length;e++){const t=this.plugins[e];await t(s)}const e={response:s.response};for(let t=0;t<i.length;t++){const r=i[t];await r(o,e)}})()):t(new Error("Operation result was not set by any plugin, make sure you have default plugins configured or review documentation"))}))}async executeQuery(e,t,r){return this.execute(e,"query",t,r)}async executeMutation(e,t){return this.execute(e,"mutation",t)}async executeSubscription(e){return await this.execute(e,"subscription")}}function j(e){const t=new q(e);return t.install=e=>{w(t),e.provide(b,t)},t}function x(){var e;const r=t.getCurrentInstance();let n=r&&t.inject(b,null===(e=null==r?void 0:r.provides)||void 0===e?void 0:e[b]);if(n&&w(n),n=m(),null==n)throw new Error("Cannot detect villus Client, did you forget to call `useClient`? Alternatively, you can explicitly pass a client as the `manualClient` argument.");return n}function C(e){const r=j(e);return t.provide(b,r),r}const P=t.defineComponent({name:"VillusClientProvider",props:{url:{type:String,required:!0},cachePolicy:{type:String,default:""},use:{type:Array,default:void 0}},setup:(e,t)=>(C({url:e.url,cachePolicy:e.cachePolicy,use:e.use}),()=>p(t,{}))});function E(e){var r;const o=null!==(r=null==e?void 0:e.client)&&void 0!==r?r:x();let{query:u,variables:i,cachePolicy:s,fetchOnMount:c}=function(e){const t={variables:{},fetchOnMount:!0};return Object.assign(Object.assign(Object.assign({},t),e),{query:e.query})}(e);const l=t.ref(null),d=t.ref(null!=c&&c),p=t.ref(!1),y=t.ref(null);let h,v;function b(e){l.value=e.data,y.value=e.error}async function g(r){const a=n(i)||{};if(e.skip&&function(e,r){return t.isRef(e)?e.value:e(r)}(e.skip,a))return d.value=!1,{data:l.value,error:y.value};d.value=!0;const c=o.executeQuery({query:t.isRef(u)?u.value:u,variables:n((null==r?void 0:r.variables)||a),cachePolicy:(null==r?void 0:r.cachePolicy)||s},t.unref(null==e?void 0:e.context),b);h=c;const f=await c;return c!==h?{data:f.data,error:f.error}:(b(f),p.value=!0,d.value=!1,h=void 0,{data:l.value,error:y.value})}t.isRef(u)&&t.watch(u,(()=>g()));const w=t.ref(!0);function m(){let e;if(!i||(r=i,!t.isRef(r)&&!t.isReactive(r)&&"function"!=typeof r))return;var r;const o=(u=i,t.computed((()=>n(u))));var u;w.value=!0,v=t.watch(o,(t=>{const r=f(a(t));r!==e&&(e=r,g())}),{deep:!0})}m();const O={data:l,isFetching:d,isDone:p,error:y,execute:g,unwatchVariables:function(){w.value&&(v(),w.value=!1)},watchVariables:function(){w.value||m()},isWatchingVariables:w},q=t.getCurrentInstance();return c&&(q?t.onMounted((()=>g())):g()),Object.assign(Object.assign({},O),{then:async e=>(c=!1,await O.execute(),e(O))})}const k=t.defineComponent({name:"Query",props:{query:{type:[String,Object],required:!0},variables:{type:Object,default:null},cachePolicy:{type:String,default:void 0},watchVariables:{type:Boolean,default:!0},suspended:{type:Boolean,default:!1},fetchOnMount:{type:Boolean,default:!0}},setup(e,r){function n(n){const{data:o,error:u,isFetching:a,isDone:i,execute:s,watchVariables:c,isWatchingVariables:l,unwatchVariables:f}=n;return t.watch(t.toRef(e,"watchVariables"),(e=>{e!==l.value&&(e?c():f())}),{immediate:!0}),()=>{const e={data:o.value,error:u.value,isFetching:a.value,isDone:i.value,execute:s};return p(r,e)}}const o={query:t.toRef(e,"query"),variables:t.toRef(e,"variables"),fetchOnMount:e.fetchOnMount,cachePolicy:e.cachePolicy};return e.suspended?E(o).then(n):n(E(o))}});function S(e,r){var n;const o=null!==(n=null==r?void 0:r.client)&&void 0!==n?n:x(),u=t.ref(null),a=t.ref(!1),i=t.ref(!1),s=t.ref(null);let c;return{data:u,isFetching:a,isDone:i,error:s,execute:async function(n){a.value=!0;const l=n||{},f=o.executeMutation({query:e,variables:l},t.unref(null==r?void 0:r.context));c=f;const d=await f;return f!==c?{data:d.data,error:d.error}:(u.value=d.data,s.value=d.error,i.value=!0,a.value=!1,c=void 0,{data:u.value,error:s.value})}}}const R=t.defineComponent({name:"Mutation",props:{query:{type:[String,Object],required:!0}},setup(e,t){const{data:r,isFetching:n,isDone:o,error:u,execute:a}=S(e.query);return()=>p(t,{data:r.value,isFetching:n.value,isDone:o.value,error:u.value,execute:a})}}),M=(e,t)=>t.data;function Q(e,r=M){var n;const o=null!==(n=e.client)&&void 0!==n?n:x(),{query:a,variables:i,paused:s}=e,c=t.ref(r(null,{data:null,error:null})),l=t.ref(null),f=t.ref(s||!1);function d(e){c.value=r(c.value,e),l.value=e.error}async function p(){f.value=!1;return(await o.executeSubscription({query:t.unref(a),variables:t.unref(i)})).subscribe({next(e){if(f.value)return;const t=function(e){if(!e.errors)return{data:e.data||null,error:null};return{data:e.data||null,error:new u({graphqlErrors:[...e.errors],response:null})}}(e);d(t)},complete(){},error(e){if(f.value)return;return d({data:null,error:new u({networkError:e,response:null})})}})}let y;const h=t.getCurrentInstance();if(!s){const e=async()=>{y=await p()};h?t.onMounted((()=>e())):e()}async function v(){y&&y.unsubscribe(),y=await p()}return h&&t.onBeforeUnmount((()=>y&&y.unsubscribe())),t.isRef(a)&&t.watch(a,v),t.isRef(i)&&t.watch(i,v),{data:c,error:l,isPaused:f,pause:function(){f.value=!0},resume:async function(){y||v(),f.value=!1}}}const V=t.defineComponent({name:"Subscription",props:{query:{type:[String,Object],required:!0},variables:{type:Object,default:null},paused:{type:Boolean,default:!1},reduce:{type:Function,default:void 0}},setup(e,r){const{data:n,error:o,pause:u,isPaused:a,resume:i}=Q({query:e.query,variables:e.variables,paused:e.paused},e.reduce||M);return t.watch(t.toRef(e,"paused"),(e=>{e!==a.value&&(e?u():i())})),()=>{const e={data:n.value,error:o.value,pause:u,isPaused:a.value,resume:i};return p(r,e)}}});e.Client=q,e.CombinedError=u,e.Mutation=R,e.Provider=P,e.Query=k,e.Subscription=V,e.VILLUS_CLIENT=b,e.cache=y,e.createClient=j,e.dedup=v,e.defaultPlugins=O,e.definePlugin=function(e){return e},e.fetch=h,e.getActiveClient=m,e.getQueryKey=d,e.handleSubscriptions=function(e){const t=e;return function({operation:e,useResult:r}){if("subscription"===e.type){if(!t)throw new Error("No subscription forwarder was set.");r(t(e),!0)}}},e.setActiveClient=w,e.useClient=C,e.useMutation=S,e.useQuery=E,e.useSubscription=Q,e.withProvider=function(e,r){return t.defineComponent({name:"VillusWithClientHoc",setup:(n,o)=>(C(r),()=>t.h(e,Object.assign(Object.assign({},n),o.attrs),o.slots))})},Object.defineProperty(e,"__esModule",{value:!0})}));