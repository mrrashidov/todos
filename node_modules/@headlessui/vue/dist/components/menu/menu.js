import{defineComponent as x,ref as b,provide as A,inject as F,onMounted as P,onUnmounted as K,computed as M,nextTick as h,watchEffect as L}from"vue";import{Features as C,render as T}from"../../utils/render.js";import{useId as O}from"../../hooks/use-id.js";import{Keys as c}from"../../keyboard.js";import{Focus as g,calculateActiveIndex as j}from"../../utils/calculate-active-index.js";import{dom as m}from"../../utils/dom.js";import{useTreeWalker as B}from"../../hooks/use-tree-walker.js";import{useOpenClosedProvider as N,State as w,useOpenClosed as U}from"../../internal/open-closed.js";import{match as $}from"../../utils/match.js";import{useResolveButtonType as V}from"../../hooks/use-resolve-button-type.js";import{FocusableMode as H,isFocusableElement as Q,sortByDomNode as _}from"../../utils/focus-management.js";import{useOutsideClick as q}from"../../hooks/use-outside-click.js";var W=(i=>(i[i.Open=0]="Open",i[i.Closed=1]="Closed",i))(W||{}),J=(i=>(i[i.Pointer=0]="Pointer",i[i.Other=1]="Other",i))(J||{});function z(l){requestAnimationFrame(()=>requestAnimationFrame(l))}let E=Symbol("MenuContext");function D(l){let S=F(E,null);if(S===null){let i=new Error(`<${l} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(i,D),i}return S}let fe=x({name:"Menu",props:{as:{type:[Object,String],default:"template"}},setup(l,{slots:S,attrs:i}){let v=b(1),e=b(null),p=b(null),r=b([]),f=b(""),d=b(null),I=b(1);function o(u=n=>n){let n=d.value!==null?r.value[d.value]:null,a=_(u(r.value.slice()),R=>m(R.dataRef.domRef)),s=n?a.indexOf(n):null;return s===-1&&(s=null),{items:a,activeItemIndex:s}}let t={menuState:v,buttonRef:e,itemsRef:p,items:r,searchQuery:f,activeItemIndex:d,activationTrigger:I,closeMenu:()=>{v.value=1,d.value=null},openMenu:()=>v.value=0,goToItem(u,n,a){let s=o(),R=j(u===g.Specific?{focus:g.Specific,id:n}:{focus:u},{resolveItems:()=>s.items,resolveActiveIndex:()=>s.activeItemIndex,resolveId:y=>y.id,resolveDisabled:y=>y.dataRef.disabled});f.value="",d.value=R,I.value=a!=null?a:1,r.value=s.items},search(u){let a=f.value!==""?0:1;f.value+=u.toLowerCase();let R=(d.value!==null?r.value.slice(d.value+a).concat(r.value.slice(0,d.value+a)):r.value).find(k=>k.dataRef.textValue.startsWith(f.value)&&!k.dataRef.disabled),y=R?r.value.indexOf(R):-1;y===-1||y===d.value||(d.value=y,I.value=1)},clearSearch(){f.value=""},registerItem(u,n){let a=o(s=>[...s,{id:u,dataRef:n}]);r.value=a.items,d.value=a.activeItemIndex,I.value=1},unregisterItem(u){let n=o(a=>{let s=a.findIndex(R=>R.id===u);return s!==-1&&a.splice(s,1),a});r.value=n.items,d.value=n.activeItemIndex,I.value=1}};return q([e,p],(u,n)=>{var a;t.closeMenu(),Q(n,H.Loose)||(u.preventDefault(),(a=m(e))==null||a.focus())},M(()=>v.value===0)),A(E,t),N(M(()=>$(v.value,{[0]:w.Open,[1]:w.Closed}))),()=>{let u={open:v.value===0};return T({props:l,slot:u,slots:S,attrs:i,name:"Menu"})}}}),me=x({name:"MenuButton",props:{disabled:{type:Boolean,default:!1},as:{type:[Object,String],default:"button"}},setup(l,{attrs:S,slots:i,expose:v}){let e=D("MenuButton"),p=`headlessui-menu-button-${O()}`;v({el:e.buttonRef,$el:e.buttonRef});function r(o){switch(o.key){case c.Space:case c.Enter:case c.ArrowDown:o.preventDefault(),o.stopPropagation(),e.openMenu(),h(()=>{var t;(t=m(e.itemsRef))==null||t.focus({preventScroll:!0}),e.goToItem(g.First)});break;case c.ArrowUp:o.preventDefault(),o.stopPropagation(),e.openMenu(),h(()=>{var t;(t=m(e.itemsRef))==null||t.focus({preventScroll:!0}),e.goToItem(g.Last)});break}}function f(o){switch(o.key){case c.Space:o.preventDefault();break}}function d(o){l.disabled||(e.menuState.value===0?(e.closeMenu(),h(()=>{var t;return(t=m(e.buttonRef))==null?void 0:t.focus({preventScroll:!0})})):(o.preventDefault(),e.openMenu(),z(()=>{var t;return(t=m(e.itemsRef))==null?void 0:t.focus({preventScroll:!0})})))}let I=V(M(()=>({as:l.as,type:S.type})),e.buttonRef);return()=>{var u;let o={open:e.menuState.value===0},t={ref:e.buttonRef,id:p,type:I.value,"aria-haspopup":!0,"aria-controls":(u=m(e.itemsRef))==null?void 0:u.id,"aria-expanded":l.disabled?void 0:e.menuState.value===0,onKeydown:r,onKeyup:f,onClick:d};return T({props:{...l,...t},slot:o,attrs:S,slots:i,name:"MenuButton"})}}}),pe=x({name:"MenuItems",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(l,{attrs:S,slots:i,expose:v}){let e=D("MenuItems"),p=`headlessui-menu-items-${O()}`,r=b(null);v({el:e.itemsRef,$el:e.itemsRef}),B({container:M(()=>m(e.itemsRef)),enabled:M(()=>e.menuState.value===0),accept(t){return t.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:t.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(t){t.setAttribute("role","none")}});function f(t){var u;switch(r.value&&clearTimeout(r.value),t.key){case c.Space:if(e.searchQuery.value!=="")return t.preventDefault(),t.stopPropagation(),e.search(t.key);case c.Enter:if(t.preventDefault(),t.stopPropagation(),e.activeItemIndex.value!==null){let a=e.items.value[e.activeItemIndex.value];(u=m(a.dataRef.domRef))==null||u.click()}e.closeMenu(),h(()=>{var n;return(n=m(e.buttonRef))==null?void 0:n.focus({preventScroll:!0})});break;case c.ArrowDown:return t.preventDefault(),t.stopPropagation(),e.goToItem(g.Next);case c.ArrowUp:return t.preventDefault(),t.stopPropagation(),e.goToItem(g.Previous);case c.Home:case c.PageUp:return t.preventDefault(),t.stopPropagation(),e.goToItem(g.First);case c.End:case c.PageDown:return t.preventDefault(),t.stopPropagation(),e.goToItem(g.Last);case c.Escape:t.preventDefault(),t.stopPropagation(),e.closeMenu(),h(()=>{var n;return(n=m(e.buttonRef))==null?void 0:n.focus({preventScroll:!0})});break;case c.Tab:t.preventDefault(),t.stopPropagation();break;default:t.key.length===1&&(e.search(t.key),r.value=setTimeout(()=>e.clearSearch(),350));break}}function d(t){switch(t.key){case c.Space:t.preventDefault();break}}let I=U(),o=M(()=>I!==null?I.value===w.Open:e.menuState.value===0);return()=>{var a,s;let t={open:e.menuState.value===0},u={"aria-activedescendant":e.activeItemIndex.value===null||(a=e.items.value[e.activeItemIndex.value])==null?void 0:a.id,"aria-labelledby":(s=m(e.buttonRef))==null?void 0:s.id,id:p,onKeydown:f,onKeyup:d,role:"menu",tabIndex:0,ref:e.itemsRef};return T({props:{...l,...u},slot:t,attrs:S,slots:i,features:C.RenderStrategy|C.Static,visible:o.value,name:"MenuItems"})}}}),ve=x({name:"MenuItem",props:{as:{type:[Object,String],default:"template"},disabled:{type:Boolean,default:!1}},setup(l,{slots:S,attrs:i,expose:v}){let e=D("MenuItem"),p=`headlessui-menu-item-${O()}`,r=b(null);v({el:r,$el:r});let f=M(()=>e.activeItemIndex.value!==null?e.items.value[e.activeItemIndex.value].id===p:!1),d=M(()=>({disabled:l.disabled,textValue:"",domRef:r}));P(()=>{var a,s;let n=(s=(a=m(r))==null?void 0:a.textContent)==null?void 0:s.toLowerCase().trim();n!==void 0&&(d.value.textValue=n)}),P(()=>e.registerItem(p,d)),K(()=>e.unregisterItem(p)),L(()=>{e.menuState.value===0&&(!f.value||e.activationTrigger.value!==0&&h(()=>{var n,a;return(a=(n=m(r))==null?void 0:n.scrollIntoView)==null?void 0:a.call(n,{block:"nearest"})}))});function I(n){if(l.disabled)return n.preventDefault();e.closeMenu(),h(()=>{var a;return(a=m(e.buttonRef))==null?void 0:a.focus({preventScroll:!0})})}function o(){if(l.disabled)return e.goToItem(g.Nothing);e.goToItem(g.Specific,p)}function t(){l.disabled||f.value||e.goToItem(g.Specific,p,0)}function u(){l.disabled||!f.value||e.goToItem(g.Nothing)}return()=>{let{disabled:n}=l,a={active:f.value,disabled:n};return T({props:{...l,...{id:p,ref:r,role:"menuitem",tabIndex:n===!0?void 0:-1,"aria-disabled":n===!0?!0:void 0,onClick:I,onFocus:o,onPointermove:t,onMousemove:t,onPointerleave:u,onMouseleave:u}},slot:a,attrs:i,slots:S,name:"MenuItem"})}}});export{fe as Menu,me as MenuButton,ve as MenuItem,pe as MenuItems};
